<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Safety Feud Online - HSE Edition</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
<style>
  :root {
    --red: #c62828; --green: #2e7d32; --blue: #1565c0; --yellow: #f9a825;
    --bg: #0d1b2a; --card: #1b263b; --accent: #00e676;
  }
  body { margin:0; font-family:'Arial Black',sans-serif; background:var(--bg); color:white; height:100vh; overflow:hidden; }
  #phoneView, #hostView { width:100%; height:100%; display:flex; flex-direction:column; justify-content:center; align-items:center; padding:20px; box-sizing:border-box; }
  #hostView { display:none; flex-direction:row; background:var(--bg); }
  h1 { font-size:4.5rem; margin:10px; text-shadow:0 0 20px var(--accent); color:var(--accent); }
  .layout { display:grid; grid-template-columns:1fr 2fr 1fr; height:100%; width:100%; gap:10px; }
  .playersCol { padding:20px; overflow-y:auto; background:rgba(0,0,0,0.3); border-radius:15px; }
  .teamBox { background:var(--card); margin:10px 0; padding:15px; border-radius:12px; border-left:8px solid; }
  .redBox    { border-color:var(--red); }
  .greenBox  { border-color:var(--green); }
  .blueBox   { border-color:var(--blue); }
  .yellowBox { border-color:var(--yellow); }
  .leader { background:gold !important; color:black; font-weight:bold; }
  #boardArea { display:flex; flex-direction:column; justify-content:center; align-items:center; }
  #question, #faceoffQuestion { font-size:3rem; text-align:center; margin:20px; padding:20px; background:rgba(0,255,65,0.15); border-radius:20px; min-height:100px; }
  #board { display:grid; grid-template-columns:repeat(auto-fit,minmax(260px,1fr)); gap:18px; max-width:1100px; width:100%; margin:20px 0; }
  .answer { background:#000080; border:7px solid white; border-radius:20px; padding:25px; font-size:2rem; position:relative; min-height:130px; transition:.4s; cursor:pointer; }
  .answer.revealed { background:#ffd700; color:black; }
  .answer .num { position:absolute; top:10px; left:15px; font-size:2.2rem; }
  .answer .txt { margin-top:40px; font-weight:bold; }
  .answer .pts { position:absolute; bottom:10px; right:20px; font-size:3rem; font-weight:bold; }
  #strikes { font-size:7rem; letter-spacing:20px; margin:30px; color:#ff1744; }
  input { padding:15px; font-size:1.8rem; width:90%; max-width:500px; margin:15px; border-radius:12px; text-align:center; }
  button { padding:15px 30px; margin:10px; font-size:1.8rem; border:none; border-radius:12px; cursor:pointer; }
  .big { padding:25px 60px; font-size:2.5rem; background:var(--accent); color:black; font-weight:bold; }
  .hidden { display:none !important; }
</style>
</head>
<body>

<!-- PHONE VIEW -->
<div id="phoneView">
  <h1>SAFETY FEUD</h1>
  <p style="font-size:2rem;color:var(--accent);">HSE Edition</p>

  <!-- Join Screen -->
  <div id="joinScreen">
    <input type="text" id="playerName" placeholder="Your Name">
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;width:90%;max-width:600px;margin-top:20px;">
      <button class="buzzer redB"    data-team="RED">RED</button>
      <button class="buzzer greenB"  data-team="GREEN">GREEN</button>
      <button class="buzzer blueB"   data-team="BLUE">BLUE</button>
      <button class="buzzer yellowB" data-team="YELLOW">YELLOW</button>
    </div>
  </div>

  <!-- Game Screen -->
  <div id="gameScreen" class="hidden">
    <h2 id="welcomeMsg"></h2>
    <p id="roleMsg" style="font-size:1.8rem;"></p>

    <!-- Face-Off Phase -->
    <div id="faceoffPhase" class="hidden">
      <div id="faceoffQuestion"></div>
      <input type="text" id="faceoffAnswer" placeholder="Type answer FAST!" autocomplete="off">
      <p style="font-size:1.5rem;color:gold;">Only Team Leaders can answer!</p>
    </div>

    <!-- Main Round Phase -->
    <div id="mainRoundPhase" class="hidden">
      <div id="controlMsg" style="font-size:2.2rem; padding:20px; background:rgba(255,255,0,0.2); border-radius:15px; margin:20px;"></div>
      <input type="text" id="mainAnswer" placeholder="Type your answer..." autocomplete="off">
    </div>
  </div>
</div>

<!-- HOST VIEW -->
<div id="hostView">
  <div class="layout">
    <div class="playersCol" id="leftTeams"></div>
    <div id="boardArea">
      <h1 id="question">Waiting for players...</h1>
      <div id="faceoffQuestionHost" class="hidden"></div>
      <div id="strikes">___</div>
      <div id="board"></div>
      <div style="margin:30px;">
        <button class="big" id="startFaceoffBtn" onclick="startFaceoff()">START FACE-OFF</button>
        <button onclick="nextRound()">NEXT ROUND</button>
        <button style="background:#ff1744;" onclick="resetGame()">RESET GAME</button>
      </div>
    </div>
    <div class="playersCol" id="rightTeams"></div>
  </div>
</div>

<script>
// ====== YOUR FIREBASE CONFIG HERE ======
const firebaseConfig = {
  apiKey: "AIzaSyCOVAn8yy3f6cGonaLNZMcFgvli-5nfu6M",
  authDomain: "safety-feud-online.firebaseapp.com",
  databaseURL: "https://safety-feud-online-default-rtdb.firebaseio.com",
  projectId: "safety-feud-online",
  storageBucket: "safety-feud-online.firebasestorage.app",
  messagingSenderId: "940458931322",
  appId: "1:940458931322:web:7f107ebe8cc761d86b37c3"
};
// ======================================

firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const gameRef = db.ref('safetyfeud');

const teams = ['RED','GREEN','BLUE','YELLOW'];
let myTeam = null, myName = null, myId = null, isLeader = false;

// Host detection
const isHost = location.search.includes('host') || screen.width > 1000;
document.getElementById('phoneView').style.display = isHost ? 'none' : 'flex';
document.getElementById('hostView').style.display = isHost ? 'flex' : 'none';

// Player Join
if (!isHost) {
  document.querySelectorAll('.buzzer').forEach(b => {
    b.onclick = () => {
      myName = document.getElementById('playerName').value.trim() || 'Player';
      myTeam = b.dataset.team;
      joinTeam();
    };
  });
}

function joinTeam() {
  myId = Date.now().toString();
  const playerRef = db.ref(`teams/${myTeam}/players/${myId}`);
  playerRef.set({ name: myName });
  playerRef.onDisconnect().remove();

  // Check if I'm the first → become leader
  db.ref(`teams/${myTeam}/leader`).once('value', snap => {
    if (!snap.val()) {
      db.ref(`teams/${myTeam}/leader`).set(myName);
      isLeader = true;
    }
  });

  document.getElementById('joinScreen').classList.add('hidden');
  document.getElementById('gameScreen').classList.remove('hidden');
  document.getElementById('welcomeMsg').textContent = `Welcome ${myName}!`;
  document.getElementById('roleMsg').innerHTML = isLeader 
    ? '<span style="color:gold;">You are the TEAM LEADER!</span>' 
    : 'Waiting for your team leader...';

  listenToGameState();
}

function listenToGameState() {
  gameRef.child('state').on('value', snap => {
    const state = snap.val() || 'waiting';
    document.getElementById('faceoffPhase').classList.add('hidden');
    document.getElementById('mainRoundPhase').classList.add('hidden');

    if (state === 'faceoff') {
      document.getElementById('faceoffPhase').classList.remove('hidden');
      if (isLeader) {
        document.getElementById('faceoffAnswer').focus();
      } else {
        document.getElementById('faceoffAnswer').disabled = true;
      }
    } else if (state === 'playing') {
      document.getElementById('mainRoundPhase').classList.remove('hidden');
      gameRef.child('controlTeam').once('value', s => {
        const ctrl = s.val();
        const msg = document.getElementById('controlMsg');
        if (ctrl === myTeam) {
          msg.innerHTML = '<span style="color:gold;">YOUR TEAM HAS CONTROL!</span><br>Type answers now!';
          document.getElementById('mainAnswer').focus();
        } else {
          msg.textContent = `${ctrl} has control`;
        }
      });
    }
  });

  // Face-off answer
  const foInput = document.getElementById('faceoffAnswer');
  foInput.onkeypress = e => {
    if (e.key === 'Enter' && isLeader) {
      gameRef.child('faceoffAnswers').push({
        team: myTeam,
        name: myName,
        answer: foInput.value.trim().toLowerCase(),
        time: Date.now()
      });
      foInput.value = 'Sent!';
      foInput.disabled = true;
    }
  };

  // Main round answer
  const mainInput = document.getElementById('mainAnswer');
  mainInput.onkeypress = e => {
    if (e.key === 'Enter') {
      const guess = mainInput.value.trim();
      if (guess) {
        gameRef.child('guesses').push({
          team: myTeam,
          name: myName,
          guess: guess.toLowerCase(),
          time: Date.now()
        });
        mainInput.value = '';
      }
    }
  };
}

// Host Logic
if (isHost) {
  teams.forEach(t => {
    db.ref(`teams/${t}`).on('value', snap => {
      const data = snap.val() || {};
      const players = Object.values(data.players || {}).map(p => p.name);
      const leader = data.leader || '—';
      const col = ['RED','YELLOW'].includes(t) ? 'leftTeams' : 'rightTeams';
      let html = `<div class="teamBox ${t.toLowerCase()}Box"><strong>${t} TEAM</strong><br>Leader: <span class="leader">${leader}</span><hr>`;
      players.forEach(p => html += p === leader ? `<div class="leader">${p} (Leader)</div>` : `<div>${p}</div>`);
      document.getElementById(col).innerHTML = html + '</div>';
    });
  });
}

// Face-Off Questions
const faceoffQuestions = [
  "What does PPE stand for?",
  "What color is a fire extinguisher for electrical fires?",
  "What should you do if you see a spill?",
  "Name the document that allows hot work?",
  "What does LOTO stand for?"
];
const faceoffAnswers = [
  ["personal protective equipment", "ppe"],
  ["black", "co2", "carbon dioxide"],
  ["report it", "clean it", "barricade", "warning"],
  ["permit to work", "hot work permit", "ptw"],
  ["lockout tagout", "lock out tag out", "loto"]
];

let currentFaceoffQ = 0;
let currentMainQ = null;

window.startFaceoff = () => {
  currentFaceoffQ = Math.floor(Math.random() * faceoffQuestions.length);
  const q = faceoffQuestions[currentFaceoffQ];
  gameRef.child('state').set('faceoff');
  document.getElementById('faceoffQuestion').textContent = q;
  document.getElementById('faceoffQuestionHost').textContent = `FACE-OFF: ${q}`;
  document.getElementById('faceoffQuestionHost').classList.remove('hidden');
  document.getElementById('startFaceoffBtn').classList.add('hidden');
  gameRef.child('faceoffAnswers').remove();
};

// Listen for face-off winner
gameRef.child('faceoffAnswers').on('child_added', snap => {
  const ans = snap.val();
  const correct = faceoffAnswers[currentFaceoffQ];
  if (correct.some(a => ans.answer.includes(a))) {
    gameRef.child('controlTeam').set(ans.team);
    gameRef.child('state').set('playing');
    document.getElementById('faceoffQuestionHost').classList.add('hidden');
    document.getElementById('startFaceoffBtn').classList.remove('hidden');
    alert(`${ans.team} wins control!`);
    loadMainQuestion();
    gameRef.child('faceoffAnswers').remove();
  }
});

// Main Round Questions
const mainQuestions = [
  {q:"Name a common type of PPE",a:[{t:"Safety Helmet",p:38},{t:"Safety Glasses",p:25},{t:"Gloves",p:15},{t:"Steel Toe Boots",p:12},{t:"High-Vis Vest",p:6},{t:"Ear Protection",p:4}]},
  {q:"Name a leading cause of workplace injuries",a:[{t:"Slips, Trips & Falls",p:42},{t:"Manual Handling",p:22},{t:"Struck by Object",p:15},{t:"Machinery",p:10},{t:"Chemical Exposure",p:6}]},
  {q:"Name something that must be reported immediately",a:[{t:"Accident/Injury",p:50},{t:"Near Miss",p:25},{t:"Unsafe Act/Condition",p:15},{t:"Spill",p:6},{t:"Fire",p:4}]},
  {q:"Name a common safety sign color meaning",a:[{t:"Red = Prohibition",p:35},{t:"Yellow = Warning",p:30},{t:"Blue = Mandatory",p:20},{t:"Green = Safe",p:15}]},
  {q:"Name a step in the hierarchy of control",a:[{t:"Elimination",p:40},{t:"Substitution",p:25},{t:"Engineering Controls",p:15},{t:"Administrative",p:12},{t:"PPE",p:8}]}
];

function loadMainQuestion() {
  const q = mainQuestions[Math.floor(Math.random() * mainQuestions.length)];
  currentMainQ = q;
  document.getElementById('question').textContent = q.q;
  const board = document.getElementById('board');
  board.innerHTML = '';
  q.a.forEach((ans,i) => {
    const div = document.createElement('div');
    div.className = 'answer hidden';
    div.innerHTML = `<div class="num">${i+1}</div><div class="txt">${ans.t.toUpperCase()}</div><div class="pts">${ans.p}</div>`;
    div.onclick = () => revealAnswer(i);
    board.appendChild(div);
  });
  gameRef.child('strikes').set(0);
  gameRef.child('guesses').remove();
}

function revealAnswer(i) {
  const el = document.querySelectorAll('.answer')[i];
  if (el.classList.contains('revealed')) return;
  el.classList.remove('hidden');
  el.classList.add('revealed');
  const points = currentMainQ.a[i].p;
  gameRef.child('controlTeam').once('value', s => {
    const team = s.val();
    db.ref(`teams/${team}/score`).transaction(v => (v||0) + points);
  });
}

// Handle guesses
gameRef.child('guesses').on('child_added', snap => {
  const g = snap.val();
  gameRef.child('controlTeam').once('value', s => {
    if (g.team !== s.val()) return;
    let found = false;
    currentMainQ.a.forEach((a,i) => {
      if (document.querySelectorAll('.answer')[i].classList.contains('revealed')) return;
      if (a.t.toLowerCase().includes(g.guess) || g.guess.includes(a.t.toLowerCase().split(' ')[0])) {
        revealAnswer(i);
        found = true;
      }
    });
    if (!found) {
      gameRef.child('strikes').transaction(v => (v||0) + 1);
    }
    snap.ref.remove();
  });
});

gameRef.child('strikes').on('value', s => {
  const strikes = s.val() || 0;
  document.getElementById('strikes').textContent = 'X'.repeat(strikes) + '_'.repeat(3 - strikes);
  if (strikes >= 3) {
    setTimeout(() => {
      alert("3 strikes! Other team can steal!");
      // In real game, allow steal here
      nextRound();
    }, 1000);
  }
});

window.nextRound = () => {
  gameRef.child('state').set('waiting');
  gameRef.child('controlTeam').set(null);
  gameRef.child('strikes').set(0);
  document.getElementById('startFaceoffBtn').classList.remove('hidden');
};

window.resetGame = () => confirm('Reset entire game?') && location.reload();
</script>
</body>
</html>
